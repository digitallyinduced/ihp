{-# LANGUAGE FlexibleInstances, UndecidableInstances #-}
{-# OPTIONS_GHC -Wno-orphans #-}
{-|
Module: IHP.Hasql.FromRow
Description: Typeclass for decoding hasql result rows
Copyright: (c) digitally induced GmbH, 2025

This module provides 'FromRowHasql', a typeclass parallel to postgresql-simple's 'FromRow',
for decoding database rows using hasql's more efficient prepared statement approach.

Instances are generated by the SchemaCompiler with explicit inline decoders in idiomatic
hasql applicative style.

Also provides parser functions used by the generated decoders for custom PostgreSQL types.
-}
module IHP.Hasql.FromRow
( FromRowHasql (..)
, HasqlDecodeColumn (..)
) where

import Prelude
import qualified Hasql.Decoders as Decoders
import qualified Hasql.Mapping.IsScalar as Mapping
import qualified Database.PostgreSQL.Simple.Types as PG
import IHP.ModelSupport.Types (LabeledData(..), Id'(..), PrimaryKey)

-- | Typeclass for types that can be decoded from a hasql result row
--
-- This is the hasql equivalent of postgresql-simple's 'FromRow' class.
-- The SchemaCompiler generates instances for all model types using idiomatic
-- hasql applicative style with explicit inline decoders.
class FromRowHasql a where
    -- | Decoder for a single row
    hasqlRowDecoder :: Decoders.Row a

-- | Typeclass for building column-level row decoders, handling nullable/non-nullable.
-- Uses 'Mapping.IsScalar' from hasql-mapping for value-level decoding.
class HasqlDecodeColumn a where
    hasqlColumnDecoder :: Decoders.Row a

instance {-# OVERLAPPABLE #-} Mapping.IsScalar a => HasqlDecodeColumn a where
    hasqlColumnDecoder = Decoders.column (Decoders.nonNullable Mapping.decoder)

instance {-# OVERLAPPING #-} Mapping.IsScalar a => HasqlDecodeColumn (Maybe a) where
    hasqlColumnDecoder = Decoders.column (Decoders.nullable Mapping.decoder)

-- | Decode 'Id' table' by decoding the primary key type and wrapping with 'Id'
instance {-# OVERLAPPING #-} Mapping.IsScalar (PrimaryKey table) => HasqlDecodeColumn (Id' table) where
    hasqlColumnDecoder = Decoders.column (Decoders.nonNullable (Id <$> Mapping.decoder))

-- | Decode 'Maybe (Id' table)' for nullable foreign keys
instance {-# OVERLAPPING #-} Mapping.IsScalar (PrimaryKey table) => HasqlDecodeColumn (Maybe (Id' table)) where
    hasqlColumnDecoder = Decoders.column (Decoders.nullable (Id <$> Mapping.decoder))

-- FromRowHasql instances for PG.Only and tuples (used by sqlQuery callers like fetchCount, fetchExists)

instance HasqlDecodeColumn a => FromRowHasql (PG.Only a) where
    hasqlRowDecoder = PG.Only <$> hasqlColumnDecoder

instance (HasqlDecodeColumn a, HasqlDecodeColumn b) => FromRowHasql (a, b) where
    hasqlRowDecoder = (,) <$> hasqlColumnDecoder <*> hasqlColumnDecoder

instance (HasqlDecodeColumn a, HasqlDecodeColumn b, HasqlDecodeColumn c) => FromRowHasql (a, b, c) where
    hasqlRowDecoder = (,,) <$> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder

instance (HasqlDecodeColumn a, HasqlDecodeColumn b, HasqlDecodeColumn c, HasqlDecodeColumn d) => FromRowHasql (a, b, c, d) where
    hasqlRowDecoder = (,,,) <$> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder

instance (HasqlDecodeColumn a, HasqlDecodeColumn b, HasqlDecodeColumn c, HasqlDecodeColumn d, HasqlDecodeColumn e) => FromRowHasql (a, b, c, d, e) where
    hasqlRowDecoder = (,,,,) <$> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder <*> hasqlColumnDecoder

instance (HasqlDecodeColumn label, FromRowHasql a) => FromRowHasql (LabeledData label a) where
    hasqlRowDecoder = LabeledData <$> hasqlColumnDecoder <*> hasqlRowDecoder
