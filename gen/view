#!/usr/bin/env php
<?php
$basePath = realpath(__DIR__ . "../../..");
$controller = ucfirst($argv[1]);
$action = $argv[2];

if ($argc < 3) {
    echo "Usage: gen/view CONTROLLER_NAME ACTION_NAME\n";
    exit(1);
}

$controllerPath = ltrim("$basePath/src/Controller/$controller.hs", '/');
if (!file_exists($controllerPath) && $controller !== 'Layout') {
    echo "Controller not found: $controllerPath\n";
    exit(1);
}

$viewDirectory = ltrim("$basePath/src/View/$controller", '/');
$viewPath = ltrim("$basePath/src/View/$controller/" . ucfirst($action) . ".hs", '/');
if (file_exists($viewPath)) {
    echo "View already exists: $viewPath\n";
    exit(1);
}

ob_start();
?>
module View.<?= $controller ?>.<?= ucfirst($action) ?> (render) where

import Foundation.ViewPrelude
import qualified View.Layout.Default

render :: Html
<?php if (strtolower($action) === 'new') { ?>
render = View.Layout.Default.html $ do
    h1 "New <?php echo $controller; ?>"
    form ! method "post" ! action "TODO" $ do
        div ! class_ "form-group" $ do
            label "Name:"
            input ! type_ "text" ! name "name" ! class_ "form-control"
        button ! type_ "submit" ! class_ "btn btn-primary" $ "Submit"
<?php } else { ?>
render = View.Layout.Default.html [hsx|
    <p>"Hello World from View.<?= $controller ?>.<?= ucfirst($action) ?>"</p>
|]
<?php } ?>
<?php
$body = ob_get_clean();

if (!file_exists($viewDirectory)) {
    echo "+ $viewDirectory\n";
    mkdir($viewDirectory);
}

file_put_contents($viewPath, $body);
echo "+ $viewPath\n";
